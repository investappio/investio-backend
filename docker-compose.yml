version: "3.8"

services:
  backend:
    image: node:lts
    depends_on:
      mongo:
        condition: service_healthy
    environment:
      - "PORT=${PORT}"
      - "NODE_ENV=development"
      - "MONGO_HOSTNAME=${MONGO_HOSTNAME}"
      - "MONGO_DATABASE=${MONGO_DATABASE}"
      - "MONGO_USERNAME=${MONGO_USERNAME}"
      - "MONGO_PASSWORD=${MONGO_PASSWORD}"
      - "JWT_SECRET=${JWT_SECRET}"
    working_dir: /home/node/app
    volumes:
      - ./src:/home/node/app/src
      - ./package.json:/home/node/app/package.json
    command: /bin/sh -c "npm i && npm start"
    ports:
      - "${PORT}:${PORT}"
    expose:
      - "${PORT}"
  stocks:
    build: ./scripts
    depends_on:
      mongo:
        condition: service_healthy
    command: "python3 get_stocks.py"
    working_dir: /usr/src/app
    volumes:
      - ./scripts:/usr/src/app
    environment:
      - "MONGO_HOSTNAME=${MONGO_HOSTNAME}"
      - "MONGO_DATABASE=${MONGO_DATABASE}"
      - "MONGO_USERNAME=${MONGO_USERNAME}"
      - "MONGO_PASSWORD=${MONGO_PASSWORD}"
      - "IEX_CLOUD_TOKEN=${IEX_CLOUD_TOKEN}"
  mongo:
    image: mongo:latest
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "echo 'db.stats().ok' | mongo admin -u ${MONGO_USERNAME} -p '${MONGO_PASSWORD}' --quiet"]
      interval: 30s
      timeout: 5s
      retries: 10
    command: [--auth]
    ports:
      - 27017:27017
    volumes:
      - ./init-mongo.sh:/docker-entrypoint-initdb.d/init-mongo.sh:ro
    environment:
      MONGO_INITDB_DATABASE: ${MONGO_DATABASE}
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
  ofelia:
    image: mcuadros/ofelia:latest
    depends_on:
      mongo:
        condition: service_healthy
    command: daemon --docker
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    labels:
      ofelia.job-run.stocks.image: "stocks"
      ofelia.job-run.stocks.schedule: "0 0 1 * * *"
      ofelia.job-run.stocks.command: "python3 python3 /usr/src/app/get_stocks.py"
